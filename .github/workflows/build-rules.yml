name: Build and Deduplicate Clash Rules

on:
  # 1. 自动触发：每天凌晨3点
  schedule:
    - cron: '0 3 * * *'
  
  # 2. 自动触发：当您修改了任何规则源文件并推送到 main 分支时
  push:
    branches:
      - main
    paths:
      - 'my_reject.txt'     # 您的私有黑名单
      - 'sources.list'      # 您的上游规则列表
      - 'my_allowlist.txt'  # 您的私有白名单

  # 3. 手动触发：允许您在 GitHub 的 "Actions" 页面手动运行
  workflow_dispatch:

jobs:
  build:
    # ★ 权限：授予 Action 写入仓库的权限
    permissions:
      contents: write

    runs-on: ubuntu-latest
    
    steps:
      # 第 1 步：签出（Checkout）您的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第 2 步：安装 yq (用于处理 .yaml 文件的工具)
      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          echo "yq version:" $(yq --version)

      # ★★★ 第 3 步：智能下载并合并“黑名单”来源 (v5 - Try/Catch 逻辑) ★★★
      - name: Download, parse, and merge rules (Blacklist)
        run: |
          echo "Starting rule download and merge process..."
          touch all_rules.tmp # 创建一个临时的合并文件

          # 循环读取 sources.list 文件
          while IFS= read -r url || [[ -n "$url" ]]; do
            # 跳过注释行和空行
            if [[ "$url" == \#* ]] || [[ -z "$url" ]]; then
              continue
            fi
            
            echo "Processing URL: $url"
            
            # 1. 先把内容下载到临时文件
            curl -s -L -o rule_content.tmp "$url"

            # 2. 检查文件是否下载成功且不为空
            if [ ! -s rule_content.tmp ]; then
              echo "  -> WARNING: Failed to download or file is empty."
              continue
            fi

            # 3. ★ 核心逻辑：Try/Catch ★
            #    我们首先“尝试”用 yq 解析。
            #    "2>/dev/null" 是关键，它会“吞掉”yq的解析错误信息，防止刷屏。
            if cat rule_content.tmp | yq e '.payload[]' - >> all_rules.tmp 2>/dev/null; then
              # “成功”(Try): yq 解析成功，说明它是一个 YAML/payload 格式的文件
              echo "  -> Parsed as YAML (yq success)"
            else
              # “失败/捕获”(Catch): yq 解析失败，说明它 100% 是一个纯文本 TXT 文件
              # 我们就把原始文件内容加入
              cat rule_content.tmp >> all_rules.tmp
              echo "  -> Parsed as TXT (yq failed, treating as plain text)"
            fi
            
          done < sources.list
          
          # 清理临时下载文件
          rm -f rule_content.tmp
          
          # 添加您自己的本地黑名单规则
          echo "Adding local rules from my_reject.txt..."
          cat my_reject.txt >> all_rules.tmp
          echo "Blacklist merge complete."

      # 第 4 步：白名单过滤 (保持不变)
      - name: Filter merged list against allowlist
        run: |
          echo "Normalizing allowlist (my_allowlist.txt)..."
          cat my_allowlist.txt \
            | sed 's/DOMAIN-SUFFIX,//g' \
            | sed "s/'//g" \
            | grep -v '^#' \
            | grep -v '^$' \
            | tr '[:upper:]' '[:lower:]' \
            | sort \
            | uniq \
            > normalized_allowlist.txt

          echo "Normalizing merged blacklist (all_rules.tmp)..."
          cat all_rules.tmp \
            | sed 's/DOMAIN-SUFFIX,//g' \
            | sed 's/DOMAIN-KEYWORD,//g' \
            | sed 's/DOMAIN,//g' \
            | sed "s/'//g" \
            | sed 's/+.//g' \
            | grep -v '^#' \
            | grep -v '^$' \
            | grep -v 'payload:' \
            | grep -v '/' \
            | grep -v ':' \
            | grep -v '@' \
            | tr '[:upper:]' '[:lower:]' \
            > normalized_blacklist.txt
            
          echo "Filtering blacklist against allowlist..."
          grep -v -x -f normalized_allowlist.txt normalized_blacklist.txt > filtered_blacklist.txt
          echo "Allowlist filtering complete."

      # 第 5 步：排序、去重并格式化为 YAML (保持不变)
      - name: Sort, deduplicate, and format as YAML
        run: |
          echo "Sorting and deduplicating filtered list..."
          cat filtered_blacklist.txt \
            | sort \
            | uniq \
            > final_reject_domains.txt

          echo "Reformatting for YAML payload..."
          echo "payload:" > final_reject.yaml
          sed "s/^\(.*\)$/  - '\1'/" final_reject_domains.txt >> final_reject.yaml
          echo "Build complete. Final file is final_reject.yaml"

      # 第 6 步：将生成的 "final_reject.yaml" 文件提交回仓库 (保持不变)
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-update reject rules (filtered by allowlist)"
          file_pattern: final_reject.yaml
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"
          commit_author: "GitHub Actions Bot <github-actions-bot@users.noreply.github.com>"
